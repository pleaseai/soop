name: Release Please

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      dry_run:
        description: Dry run — build binaries but skip npm publish
        type: boolean
        default: false

jobs:
  # -------------------------------------------------------------------------
  # Job 1: Create / update release PR (push to main only)
  # -------------------------------------------------------------------------
  release-please:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
    steps:
      - uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          token: ${{ steps.app-token.outputs.token }}
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

      # Update bun.lock — release-please bumps package.json versions
      # but does not regenerate the lockfile
      - uses: actions/checkout@v4
        if: steps.release.outputs.pr && !steps.release.outputs.release_created
        with:
          token: ${{ steps.app-token.outputs.token }}
          ref: release-please--branches--main

      - uses: oven-sh/setup-bun@v2
        if: steps.release.outputs.pr && !steps.release.outputs.release_created

      - name: Update bun.lock in release PR
        if: steps.release.outputs.pr && !steps.release.outputs.release_created
        run: |
          bun install
          if git diff --quiet bun.lock; then
            echo "bun.lock is already up to date"
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add bun.lock
          git commit -m "chore: update bun.lock"
          git push

  # -------------------------------------------------------------------------
  # Job 2: Build platform binaries (matrix — each OS builds its own targets)
  #
  # Runs when:
  #   - push: release was created by release-please
  #   - workflow_dispatch: always (manual trigger)
  # -------------------------------------------------------------------------
  build-binaries:
    needs: release-please
    if: |
      always() && (
        (github.event_name == 'push' &&
          needs.release-please.result == 'success' &&
          needs.release-please.outputs.release_created == 'true') ||
        github.event_name == 'workflow_dispatch'
      )
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS — builds darwin-arm64 and darwin-x64 natively on Apple Silicon
          - os: macos-latest
            filter: darwin
            artifact: darwin

          # Linux x64 — builds linux-x64-glibc and linux-x64-musl
          - os: ubuntu-latest
            filter: linux-x64
            artifact: linux-x64

          # Linux arm64 — builds linux-arm64-glibc and linux-arm64-musl
          - os: ubuntu-24.04-arm
            filter: linux-arm64
            artifact: linux-arm64

          # Windows x64
          - os: windows-latest
            filter: win32
            artifact: win32

    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build binaries (${{ matrix.filter }})
        run: bun run scripts/generate-packages.ts --filter ${{ matrix.filter }}

      - name: Upload binaries
        uses: actions/upload-artifact@v4
        with:
          name: binaries-${{ matrix.artifact }}
          path: npm/
          retention-days: 1

  # -------------------------------------------------------------------------
  # Job 3: Collect all platform packages and publish to npm
  # -------------------------------------------------------------------------
  publish:
    needs: [release-please, build-binaries]
    if: |
      always() &&
      needs.build-binaries.result == 'success' && (
        (github.event_name == 'push' &&
          needs.release-please.result == 'success' &&
          needs.release-please.outputs.release_created == 'true') ||
        github.event_name == 'workflow_dispatch'
      )
    runs-on: ubuntu-latest
    env:
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
      TURBO_TEAM: ${{ secrets.TURBO_TEAM }}
    permissions:
      contents: read
      id-token: write # Required for npm OIDC trusted publishing
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - uses: actions/setup-node@v4
        with:
          node-version: '24'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build main package
        run: bunx turbo run build

      - name: Download all platform binaries
        uses: actions/download-artifact@v4
        with:
          pattern: binaries-*
          path: npm/
          merge-multiple: true

      - name: List collected packages
        run: ls -la npm/

      # Sync optionalDependencies in packages/soop/package.json to current version
      - name: Bump optional dependency versions
        run: bun run scripts/bump-version.ts

      # Publish platform packages first — main package references them via optionalDependencies
      - name: Publish platform packages
        if: ${{ github.event.inputs.dry_run != 'true' }}
        run: |
          for dir in npm/soop-*/; do
            name=$(cat "$dir/package.json" | python3 -c "import json,sys; print(json.load(sys.stdin)['name'])")
            version=$(cat "$dir/package.json" | python3 -c "import json,sys; print(json.load(sys.stdin)['version'])")
            if npm view "${name}@${version}" version 2>/dev/null | grep -q "${version}"; then
              echo "Skipping $name@$version (already published)"
            else
              echo "Publishing $dir..."
              (cd "$dir" && npm publish --access public --provenance)
            fi
          done
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      # Publish main @pleaseai/soop package (OIDC trusted publishing — no token needed)
      - name: Publish main package
        if: ${{ github.event.inputs.dry_run != 'true' }}
        run: |
          name=$(cat packages/soop/package.json | python3 -c "import json,sys; print(json.load(sys.stdin)['name'])")
          version=$(cat packages/soop/package.json | python3 -c "import json,sys; print(json.load(sys.stdin)['version'])")
          if npm view "${name}@${version}" version 2>/dev/null | grep -q "${version}"; then
            echo "Skipping ${name}@${version} (already published)"
          else
            cd packages/soop && npm publish --access public --provenance
          fi

      # Dry run — show what would be published
      - name: Dry run summary
        if: ${{ github.event.inputs.dry_run == 'true' }}
        run: |
          echo "=== DRY RUN: packages that would be published ==="
          for dir in npm/soop-*/; do
            name=$(cat "$dir/package.json" | python3 -c "import json,sys; print(json.load(sys.stdin)['name'])")
            version=$(cat "$dir/package.json" | python3 -c "import json,sys; print(json.load(sys.stdin)['version'])")
            echo "  $name@$version"
          done
          echo "  @pleaseai/soop (main package)"
